import { router } from '@kit.ArkUI';
import { DateUtils } from '../model/DateUtils';
import { UserPreferences } from '../model/UserPreferences';
import { ThemeManager, ThemeColors } from '../model/ThemeManager';

@Entry
@Component
struct Index {
  @State currentWeek: number = DateUtils.getCurrentWeek();
  @State favoriteCampus: string = '';
  @StorageLink('isDarkMode') isDarkMode: boolean = false;

  aboutToAppear() {
    // åˆå§‹åŒ–ä¸»é¢˜ç®¡ç†å™¨
    ThemeManager.getInstance();
    
    // åŠ è½½ç”¨æˆ·åå¥½
    this.favoriteCampus = UserPreferences.getFavoriteCampus();
  }

  onPageShow() {
    // é¡µé¢æ˜¾ç¤ºæ—¶é‡æ–°åŠ è½½ç”¨æˆ·åå¥½
    this.favoriteCampus = UserPreferences.getFavoriteCampus();
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜åŒºåŸŸ
      Column({ space: 16 }) {
        // æ ‡é¢˜å’Œä¸»é¢˜åˆ‡æ¢æŒ‰é’®
        Row() {
          Column({ space: 8 }) {
            Text('HITç©ºæ•™å®¤æŸ¥è¯¢')
              .fontSize(28)
              .fontWeight(FontWeight.Bold)
              .fontColor(ThemeColors.getPrimaryTextColor(this.isDarkMode))
            
            Text('å¿«é€ŸæŸ¥è¯¢æ ¡å›­ç©ºé—²æ•™å®¤')
              .fontSize(16)
              .fontColor(ThemeColors.getSecondaryTextColor(this.isDarkMode))
          }
          .alignItems(HorizontalAlign.Start)
          .layoutWeight(1)
          
          // ä¸»é¢˜åˆ‡æ¢æŒ‰é’®
          Button(this.isDarkMode ? 'ğŸŒ™' : 'â˜€ï¸')
            .backgroundColor(ThemeColors.getCardBackgroundColor(this.isDarkMode))
            .fontColor(ThemeColors.getPrimaryTextColor(this.isDarkMode))
            .borderRadius(20)
            .width(40)
            .height(40)
            .onClick(() => {
              ThemeManager.getInstance().toggleTheme();
              this.isDarkMode = ThemeManager.getInstance().getIsDarkMode();
            })
        }
        .width('100%')
        .alignItems(VerticalAlign.Center)

        // ç”¨æˆ·åå¥½ä¿¡æ¯
        if (this.favoriteCampus) {
          Row({ space: 8 }) {
            Text('å¸¸ç”¨æ ¡åŒº:')
              .fontSize(14)
              .fontColor(ThemeColors.getTertiaryTextColor(this.isDarkMode))
            Text(this.favoriteCampus)
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor(ThemeColors.getPrimaryColor())
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
              .backgroundColor(ThemeColors.getPrimaryLightColor(this.isDarkMode))
              .borderRadius(8)
          }
        }

        // å½“å‰å‘¨æ¬¡ä¿¡æ¯
        Row({ space: 8 }) {
          Text('å½“å‰æ˜¯')
            .fontSize(14)
            .fontColor(ThemeColors.getTertiaryTextColor(this.isDarkMode))
          Text(`ç¬¬${this.currentWeek}å‘¨`)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor(ThemeColors.getPrimaryColor())
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .backgroundColor(ThemeColors.getPrimaryLightColor(this.isDarkMode))
            .borderRadius(8)
        }
      }
      .width('100%')
      .padding({ top: 40, bottom: 60, left: 24, right: 24 })
      .justifyContent(FlexAlign.Center)

      // åŠŸèƒ½åŒºåŸŸ
      Column({ space: 24 }) {
        // å¿«é€ŸæŸ¥è¯¢ä»Šæ—¥ç©ºæ•™å®¤
        Row() {
          Column({ space: 8 }) {
            Text('ğŸš€ å¿«é€ŸæŸ¥è¯¢')
              .fontSize(20)
              .fontWeight(FontWeight.Medium)
              .fontColor(ThemeColors.getPrimaryTextColor(this.isDarkMode))
            Text(this.favoriteCampus ? `${this.favoriteCampus} - æŸ¥çœ‹ä»Šå¤©çš„ç©ºé—²æ•™å®¤` : 'æŸ¥çœ‹ä»Šå¤©çš„ç©ºé—²æ•™å®¤')
              .fontSize(14)
              .fontColor(ThemeColors.getSecondaryTextColor(this.isDarkMode))
          }
          .alignItems(HorizontalAlign.Start)
          .layoutWeight(1)

          Text('ğŸ«')
            .fontSize(32)
        }
        .width('100%')
        .padding(24)
        .backgroundColor(ThemeColors.getCardBackgroundColor(this.isDarkMode))
        .borderRadius(16)
        .shadow({
          radius: 12,
          color: ThemeColors.getShadowColor(this.isDarkMode),
          offsetX: 0,
          offsetY: 4
        })
        .onClick(() => {
          router.pushUrl({
            url: 'pages/CampusSelectionPage',
            params: {
              selectedDate: new Date().getTime()
            }
          });
        })

        // è‡ªå®šä¹‰æŸ¥è¯¢
        Row() {
          Column({ space: 8 }) {
            Text('ğŸ“… è‡ªå®šä¹‰æŸ¥è¯¢')
              .fontSize(20)
              .fontWeight(FontWeight.Medium)
              .fontColor(ThemeColors.getPrimaryTextColor(this.isDarkMode))
            Text('é€‰æ‹©æ—¥æœŸå’Œåœ°ç‚¹æŸ¥è¯¢')
              .fontSize(14)
              .fontColor(ThemeColors.getSecondaryTextColor(this.isDarkMode))
          }
          .alignItems(HorizontalAlign.Start)
          .layoutWeight(1)

          Text('ğŸ“…')
            .fontSize(32)
        }
        .width('100%')
        .padding(24)
        .backgroundColor(ThemeColors.getCardBackgroundColor(this.isDarkMode))
        .borderRadius(16)
        .shadow({
          radius: 12,
          color: ThemeColors.getShadowColor(this.isDarkMode),
          offsetX: 0,
          offsetY: 4
        })
        .onClick(() => {
          router.pushUrl({
            url: 'pages/DateSelectionPage'
          });
        })



        // ä½¿ç”¨è¯´æ˜
        Column({ space: 12 }) {
          Text('ğŸ’¡ ä½¿ç”¨è¯´æ˜')
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor(ThemeColors.getPrimaryTextColor(this.isDarkMode))
            .alignSelf(ItemAlign.Start)

          Column({ space: 8 }) {
            Text('â€¢ é€‰æ‹©æŸ¥è¯¢æ—¥æœŸï¼ˆä»Šå¤©æˆ–å…¶ä»–æ—¥æœŸï¼‰')
              .fontSize(14)
              .fontColor(ThemeColors.getSecondaryTextColor(this.isDarkMode))
              .alignSelf(ItemAlign.Start)
            Text('â€¢ é€‰æ‹©æ ¡åŒºï¼ˆä¸€æ ¡åŒºæˆ–äºŒæ ¡åŒºï¼‰')
              .fontSize(14)
              .fontColor(ThemeColors.getSecondaryTextColor(this.isDarkMode))
              .alignSelf(ItemAlign.Start)
            Text('â€¢ é€‰æ‹©æ•™å­¦æ¥¼')
              .fontSize(14)
              .fontColor(ThemeColors.getSecondaryTextColor(this.isDarkMode))
              .alignSelf(ItemAlign.Start)
            Text('â€¢ æŸ¥çœ‹ç©ºé—²æ•™å®¤ï¼ŒæŒ‰æ¥¼å±‚æ’åˆ—')
              .fontSize(14)
              .fontColor(ThemeColors.getSecondaryTextColor(this.isDarkMode))
              .alignSelf(ItemAlign.Start)
          }
        }
        .width('100%')
        .padding(20)
        .backgroundColor(ThemeColors.getCardBackgroundColor(this.isDarkMode))
        .borderRadius(12)
      }
      .width('100%')
      .padding(24)
      .layoutWeight(1)
      .justifyContent(FlexAlign.Start)

      // åº•éƒ¨ä¿¡æ¯
      Column({ space: 8 }) {
        Text('æ•°æ®æ¥æºï¼šæ•™åŠ¡å¤„è¯¾è¡¨æ•°æ®')
          .fontSize(12)
          .fontColor(ThemeColors.getTertiaryTextColor(this.isDarkMode))
        Text('å®æ—¶æ›´æ–° Â· å‡†ç¡®å¯é ')
          .fontSize(12)
          .fontColor(ThemeColors.getPrimaryColor())
      }
      .padding({ bottom: 50 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor(ThemeColors.getBackgroundColor(this.isDarkMode))
  }
}