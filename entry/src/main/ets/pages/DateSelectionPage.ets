import { router } from '@kit.ArkUI';
import { DateUtils } from '../model/DateUtils';
import { ThemeManager, ThemeColors } from '../model/ThemeManager';

@Entry
@Component
struct DateSelectionPage {
  @State selectedDate: Date = new Date();
  @State showDatePicker: boolean = false;
  @StorageLink('isDarkMode') isDarkMode: boolean = false;

  aboutToAppear() {
    // åˆå§‹åŒ–ä¸»é¢˜ç®¡ç†å™¨
    ThemeManager.getInstance();
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('â†')
          .fontSize(24)
          .fontColor(ThemeColors.getPrimaryColor())
          .onClick(() => {
            router.back();
          })
          .margin({ right: 16 })

        Text('é€‰æ‹©æŸ¥è¯¢æ—¥æœŸ')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(ThemeColors.getPrimaryTextColor(this.isDarkMode))
          .layoutWeight(1)
      }
      .width('100%')
      .height(60)
      .padding({ left: 16, right: 16 })
      .backgroundColor(ThemeColors.getTopBarBackgroundColor(this.isDarkMode))
      .alignItems(VerticalAlign.Center)

      Column({ space: 20 }) {
        // å½“å‰æ—¥æœŸä¿¡æ¯
        Column({ space: 8 }) {
          Text(`ä»Šå¤©æ˜¯ç¬¬${DateUtils.getCurrentWeek()}å‘¨`)
            .fontSize(16)
            .fontColor(ThemeColors.getSecondaryTextColor(this.isDarkMode))
          Text(`${DateUtils.formatDate(new Date())} ${DateUtils.getDayOfWeekChinese(new Date())}`)
            .fontSize(14)
            .fontColor(ThemeColors.getTertiaryTextColor(this.isDarkMode))
        }
        .margin({ top: 30 })

        // é€‰æ‹©é€‰é¡¹
        Column({ space: 16 }) {
          // ä»Šå¤©é€‰é¡¹
          Row() {
            Column({ space: 4 }) {
              Text('æŸ¥è¯¢ä»Šå¤©')
                .fontSize(18)
                .fontWeight(FontWeight.Medium)
                .fontColor(ThemeColors.getPrimaryTextColor(this.isDarkMode))
              Text('å¿«é€ŸæŸ¥çœ‹ä»Šæ—¥ç©ºæ•™å®¤')
                .fontSize(14)
                .fontColor(ThemeColors.getSecondaryTextColor(this.isDarkMode))
            }
            .alignItems(HorizontalAlign.Start)
            .layoutWeight(1)

            Text('ðŸ“…')
              .fontSize(24)
              .fontColor(ThemeColors.getPrimaryColor())
          }
          .width('100%')
          .padding({ left: 20, right: 20, top: 20, bottom: 20 })
          .backgroundColor(ThemeColors.getCardBackgroundColor(this.isDarkMode))
          .borderRadius(12)
          .shadow({
            radius: 8,
            color: ThemeColors.getShadowColor(this.isDarkMode),
            offsetX: 0,
            offsetY: 2
          })
          .onClick(() => {
            this.goToCampusSelection(new Date());
          })

          // å…¶ä»–æ—¥æœŸé€‰é¡¹
          Row() {
            Column({ space: 4 }) {
              Text('é€‰æ‹©å…¶ä»–æ—¥æœŸ')
                .fontSize(18)
                .fontWeight(FontWeight.Medium)
                .fontColor(ThemeColors.getPrimaryTextColor(this.isDarkMode))
              Text(this.selectedDate.getTime() === new Date().setHours(0,0,0,0) ? 
                   'ç‚¹å‡»é€‰æ‹©æŸ¥è¯¢æ—¥æœŸ' : 
                   `å·²é€‰æ‹©: ${DateUtils.formatDate(this.selectedDate)} ${DateUtils.getDayOfWeekChinese(this.selectedDate)}`)
                .fontSize(14)
                .fontColor(ThemeColors.getSecondaryTextColor(this.isDarkMode))
            }
            .alignItems(HorizontalAlign.Start)
            .layoutWeight(1)

            Text('ðŸ“†')
              .fontSize(24)
              .fontColor(ThemeColors.getPrimaryColor())
          }
          .width('100%')
          .padding({ left: 20, right: 20, top: 20, bottom: 20 })
          .backgroundColor(ThemeColors.getCardBackgroundColor(this.isDarkMode))
          .borderRadius(12)
          .shadow({
            radius: 8,
            color: ThemeColors.getShadowColor(this.isDarkMode),
            offsetX: 0,
            offsetY: 2
          })
          .onClick(() => {
            this.showDatePicker = true;
          })

          // ç¡®è®¤æŒ‰é’®ï¼ˆä»…åœ¨é€‰æ‹©äº†å…¶ä»–æ—¥æœŸæ—¶æ˜¾ç¤ºï¼‰
          if (this.selectedDate.getTime() !== new Date().setHours(0,0,0,0)) {
            Button('ç¡®è®¤æŸ¥è¯¢')
              .width('100%')
              .height(48)
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .backgroundColor(ThemeColors.getPrimaryColor())
              .fontColor('#ffffff')
              .borderRadius(24)
              .onClick(() => {
                this.goToCampusSelection(this.selectedDate);
              })
          }
        }
        .margin({ top: 40 })
        .padding({ left: 20, right: 20, bottom: 50 }) // å¢žåŠ åº•éƒ¨é—´è·
      }
      .width('100%')
      .layoutWeight(1)
      .justifyContent(FlexAlign.Start)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(ThemeColors.getBackgroundColor(this.isDarkMode))
    .bindSheet($$this.showDatePicker, this.datePickerBuilder(), {
      height: 350,
      dragBar: true,
      backgroundColor: ThemeColors.getCardBackgroundColor(this.isDarkMode),
      onDisappear: () => {
        this.showDatePicker = false;
      }
    })
  }

  @Builder
  datePickerBuilder() {
    Column() {
      Text('é€‰æ‹©æ—¥æœŸ')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor(ThemeColors.getPrimaryTextColor(this.isDarkMode))
        .margin({ top: 20, bottom: 20 })

      DatePicker({
        start: new Date(2025, 1, 24), // å­¦æœŸå¼€å§‹
        end: new Date(2025, 6, 30),   // å­¦æœŸç»“æŸ
        selected: this.selectedDate
      })
        .onDateChange((value: Date) => {
          this.selectedDate = value;
        })

      Row({ space: 20 }) {
        Button('å–æ¶ˆ')
          .width(100)
          .height(40)
          .backgroundColor(ThemeColors.getCardBackgroundColor(this.isDarkMode))
          .fontColor(ThemeColors.getSecondaryTextColor(this.isDarkMode))
          .border({
            width: 1,
            color: ThemeColors.getDividerColor(this.isDarkMode)
          })
          .onClick(() => {
            this.showDatePicker = false;
          })

        Button('ç¡®å®š')
          .width(100)
          .height(40)
          .backgroundColor(ThemeColors.getPrimaryColor())
          .fontColor('#ffffff')
          .onClick(() => {
            this.showDatePicker = false;
          })
      }
      .margin({ top: 20, bottom: 20 })
    }
    .padding(20)
    .backgroundColor(ThemeColors.getCardBackgroundColor(this.isDarkMode))
  }

  private goToCampusSelection(date: Date) {
    router.pushUrl({
      url: 'pages/CampusSelectionPage',
      params: {
        selectedDate: date.getTime()
      }
    });
  }
} 